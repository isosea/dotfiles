#!/bin/bash
{{ if eq .chezmoi.os "darwin" -}}

set -euo pipefail

CONFIG_FILE="$HOME/.local/share/chezmoi/.chezmoidata/packages.yaml"

# yq が必要
if ! command -v yq &>/dev/null; then
  echo "yq が必要です: brew install yq"
  exit 1
fi

# fzf が必要
if ! command -v fzf &>/dev/null; then
  echo "fzf が必要です: brew install fzf"
  exit 1
fi

# brewパッケージ一覧取得
brews=$(yq '.packages.darwin.available_brews[]' "$CONFIG_FILE")
casks=$(yq '.packages.darwin.available_casks[]' "$CONFIG_FILE")

# 選択肢を整形
choices=$(cat <<EOF
== BREW ==
$brews
== CASK ==
$casks
EOF
)

# fzfで選択 (複数選択可、見出しは選べないように --no-select)
selected=$(echo "$choices" | \
  fzf -m --prompt="インストールするパッケージを選んでください > " \
      --header-lines=1 \
      --bind "enter:toggle+accept" \
      --delimiter " " \
      --with-nth=1.. \
      --tac \
      | grep -v '^==')

if [ -z "$selected" ]; then
  echo "キャンセルしました"
  exit 0
fi

# 選んだやつが brew か cask かを判定してインストール
echo "$selected" | while read -r pkg; do
  if echo "$brews" | grep -qx "$pkg"; then
    echo "==> brew install $pkg"
    brew install "$pkg"
  elif echo "$casks" | grep -qx "$pkg"; then
    echo "==> brew install --cask $pkg"
    brew install --cask "$pkg"
  fi
done

{{ end -}}
